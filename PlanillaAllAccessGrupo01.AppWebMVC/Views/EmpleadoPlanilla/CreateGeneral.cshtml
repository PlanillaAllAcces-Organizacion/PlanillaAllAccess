@model PlanillaAllAccessGrupo01.AppWebMVC.Models.EmpleadoPlanilla

@{
    ViewData["Title"] = "Generar Planilla General de Pago";
}

<div class="container">
    <h2 class="mb-4">@ViewData["Title"]</h2>

    <!-- Mostrar mensajes temporales -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <form asp-action="BuscarInformacionEmpleados" method="post" id="planillaForm">
        @Html.AntiForgeryToken()

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filtros de Búsqueda</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">Fecha Inicio*</label>
                            <input type="date" class="form-control" id="fechaInicio" name="fechaInicio"
                                   value="@(ViewBag.FechaInicio?.ToString("yyyy-MM-dd") ?? DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd"))" required />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="control-label">Fecha Fin*</label>
                            <input type="date" class="form-control" id="fechaFin" name="fechaFin"
                                   value="@(ViewBag.FechaFin?.ToString("yyyy-MM-dd") ?? DateTime.Now.ToString("yyyy-MM-dd"))" required />
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-12 text-center">
                        <button type="submit" class="btn btn-primary mr-2" id="btnBuscar">
                            <i class="fas fa-search"></i> Buscar Información
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Resumen General -->
    @if (ViewBag.EmpleadosInfo != null)
    {
        <form asp-action="GenerarPlanillaGeneral" method="post" id="formPlanillaGeneral">
            @Html.AntiForgeryToken()
            <input type="hidden" name="fechaInicio" value="@ViewBag.FechaInicio.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="fechaFin" value="@ViewBag.FechaFin.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="planillaId" value="@ViewBag.PlanillaId" />

            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Resumen General</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Total Empleados</h6>
                                    <p class="card-text h4">@ViewBag.EmpleadosInfo.Count</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Total Salarios</h6>
                                    <p class="card-text h4">@ViewBag.SalarioBaseGeneral.ToString("C", CultureInfo.GetCultureInfo("en-US"))</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Total Horas Extras</h6>
                                    <p class="card-text h4">@ViewBag.TotalHorasExtrasGeneral</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-light mb-3">
                                <div class="card-body text-center">
                                    <h6 class="card-title">Total Nómina</h6>
                                    <p class="card-text h4 text-success font-weight-bold">@ViewBag.TotalSalarioNetoGeneral.ToString("C", CultureInfo.GetCultureInfo("en-US"))</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalle por Empleado -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Detalle por Empleado</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-light mr-2" id="btnExportarExcel">
                                <i class="fas fa-file-excel"></i> Excel
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-light" id="btnExportarPDF">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered" id="tablaEmpleados">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Empleado</th>
                                    <th>Puesto</th>
                                    <th>Días Trab.</th>
                                    <th>Horas Ext.</th>
                                    <th>Horas Tard.</th>
                                    <th>Salario Base</th>
                                    <th>Bonos</th>
                                    <th>Descuentos</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var empleado in ViewBag.EmpleadosInfo)
                                {
                                    <tr>
                                        <td>@empleado.Nombre</td>
                                        <td>@empleado.PuestoTrabajo</td>
                                        <td class="text-center">@empleado.DiasTrabajados</td>
                                        <td class="text-center">@empleado.HorasExtras</td>
                                        <td class="text-center">@empleado.HorasTardias</td>
                                        <td class="text-right">@string.Format(new System.Globalization.CultureInfo("en-US"), "{0:C}", empleado.SalarioBase)</td>
                                        <td class="text-right">@string.Format(new System.Globalization.CultureInfo("en-US"), "{0:C}", empleado.TotalBonos)</td>
                                        <td class="text-right">@string.Format(new System.Globalization.CultureInfo("en-US"), "{0:C}", empleado.TotalDescuentos)</td>
                                        <td class="text-right font-weight-bold">@string.Format(new System.Globalization.CultureInfo("en-US"), "{0:C}", empleado.SalarioNeto)</td>

                                    </tr>
                                }
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <th colspan="5" class="text-right">Totales:</th>
                                @using System.Globalization

                                    <th class="text-right">@ViewBag.SalarioBaseGeneral.ToString("C", CultureInfo.GetCultureInfo("en-US"))</th>
                                    <th class="text-right">@ViewBag.TotalBonosGeneral.ToString("C", CultureInfo.GetCultureInfo("en-US"))</th>
                                    <th class="text-right">@ViewBag.TotalDescuentosGeneral.ToString("C", CultureInfo.GetCultureInfo("en-US"))</th>
                                    <th class="text-right text-success">@ViewBag.TotalSalarioNetoGeneral.ToString("C", CultureInfo.GetCultureInfo("en-US"))</th>

                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="form-group text-right">
                <a asp-action="Index" class="btn btn-secondary mr-2">
                    <i class="fas fa-arrow-left"></i> Volver al Listado
                </a>
                <button type="submit" class="btn btn-success" id="btnGenerarPlanilla">
                    <i class="fas fa-file-invoice-dollar"></i> Generar Planilla General
                </button>
            </div>
        </form>
    }
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap4.min.css" />

    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap4.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>

    <script>
        $(document).ready(function() {
            // Validar fechas antes de enviar el formulario
            $('#planillaForm').submit(function(e) {
                const fechaInicio = new Date($('#fechaInicio').val());
                const fechaFin = new Date($('#fechaFin').val());

                if (fechaInicio && fechaFin && fechaFin < fechaInicio) {
                    alert('La fecha fin debe ser mayor o igual a la fecha inicio');
                    return false;
                }
                return true;
            });

            // Confirmación antes de generar planilla
            $('#formPlanillaGeneral').submit(function(e) {
                if (!confirm('¿Está seguro que desea generar la planilla general para todos los empleados?')) {
                    return false;
                }
                $('#btnGenerarPlanilla').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Procesando...');
            });

            // Inicializar DataTable con botones de exportación
            if ($('#tablaEmpleados').length) {
                $('#tablaEmpleados').DataTable({
                    dom: "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                         "<'row'<'col-sm-12'tr>>" +
                         "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                    buttons: [
                        {
                            extend: 'excel',
                            text: '<i class="fas fa-file-excel"></i> Excel',
                            className: 'btn btn-success btn-sm',
                            title: 'Planilla General',
                            exportOptions: {
                                columns: ':visible'
                            }
                        },
                        {
                            extend: 'pdf',
                            text: '<i class="fas fa-file-pdf"></i> PDF',
                            className: 'btn btn-danger btn-sm',
                            title: 'Planilla General',
                            exportOptions: {
                                columns: ':visible'
                            }
                        },
                        {
                            extend: 'print',
                            text: '<i class="fas fa-print"></i> Imprimir',
                            className: 'btn btn-info btn-sm',
                            title: 'Planilla General',
                            exportOptions: {
                                columns: ':visible'
                            }
                        }
                    ],
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
                    },
                    columnDefs: [
                        { className: "text-right", targets: [5,6,7,8] },
                        { className: "text-center", targets: [2,3,4] }
                    ],
                    order: [[0, 'asc']],
                    pageLength: 10,
                    responsive: true
                });
            }

            // Botones de exportación personalizados
            $('#btnExportarExcel').click(function() {
                $('#tablaEmpleados').DataTable().button('.buttons-excel').trigger();
            });

            $('#btnExportarPDF').click(function() {
                $('#tablaEmpleados').DataTable().button('.buttons-pdf').trigger();
            });
        });
    </script>

    <style>
        .card {
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .card-header {
            border-radius: 5px 5px 0 0 !important;
        }

        .table th {
            white-space: nowrap;
            vertical-align: middle;
        }

        .table td {
            vertical-align: middle;
        }

        .h4 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .dataTables_wrapper .dataTables_filter input {
            border-radius: 4px;
            border: 1px solid #ced4da;
            padding: 0.375rem 0.75rem;
        }

        .dataTables_wrapper .dataTables_length select {
            border-radius: 4px;
            border: 1px solid #ced4da;
            padding: 0.375rem 0.75rem;
        }

        .dt-buttons .btn {
            margin-right: 5px;
        }

        .table thead th {
            background-color: #343a40;
            color: white;
        }
    </style>
}